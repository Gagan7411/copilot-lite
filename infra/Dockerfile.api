FROM node:20-alpine

WORKDIR /app

RUN npm install -g pnpm

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./
COPY apps/api/package.json ./apps/api/
COPY packages/common/package.json ./packages/common/
COPY packages/analyzer/package.json ./packages/analyzer/
COPY packages/diff/package.json ./packages/diff/

RUN pnpm install --frozen-lockfile

COPY . .

RUN pnpm --filter common build
RUN pnpm --filter analyzer build
RUN pnpm --filter diff build
RUN pnpm --filter api build

EXPOSE 4000

CMD ["pnpm", "--filter", "api", "start"]
